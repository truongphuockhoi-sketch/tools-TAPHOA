<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video to Prompt - AI Tools Hub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            padding: 20px 0;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        /* Token Section - Thu g·ªçn */
        .token-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .token-header {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.3s ease;
        }

        .token-header:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .token-icon {
            font-size: 1.2rem;
        }

        .token-title {
            font-weight: bold;
            flex-grow: 1;
        }

        .token-arrow {
            transition: transform 0.3s ease;
            font-size: 0.9rem;
        }

        .token-section.expanded .token-arrow {
            transform: rotate(180deg);
        }

        .token-status {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: #666;
        }

        .token-status.has-token {
            background: #4ecdc4;
        }

        .token-content {
            display: none;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .token-section.expanded .token-content {
            display: block;
        }

        .token-instruction {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .token-instruction ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .token-instruction li {
            margin-bottom: 5px;
        }

        .token-instruction a {
            color: #4ecdc4;
            text-decoration: none;
        }

        .token-instruction a:hover {
            text-decoration: underline;
        }

        .token-input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .token-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .token-btn {
            background: #4ecdc4;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            flex: 1;
            justify-content: center;
        }

        .token-btn:hover {
            background: #3dbeb5;
            transform: translateY(-2px);
        }

        .token-btn-clear {
            background: #666;
        }

        .token-btn-clear:hover {
            background: #555;
        }

        .token-btn-close {
            background: #ff6b6b;
            flex: 0.5;
        }

        .token-btn-close:hover {
            background: #ff5252;
        }

        .token-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 5px;
            border-left: 3px solid #4caf50;
        }

        .token-info p {
            margin: 0;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .btn-icon {
            font-size: 1rem;
        }

        /* Upload Area */
        .upload-area {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }
        .upload-area.dragover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff6b6b;
        }
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        /* Buttons */
        .btn {
            background: #ff6b6b;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: transparent;
            border: 2px solid #ff6b6b;
        }
        
        /* Video Preview */
        .video-preview {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .video-preview video {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            margin: 30px 0;
        }
        .loading-spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #ff6b6b;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Results */
        .results {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }
        .result-section {
            margin-bottom: 25px;
        }
        .result-section h3 {
            margin-bottom: 15px;
            color: #ff6b6b;
        }
        .prompt-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ff6b6b;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
        }
        .copy-btn {
            background: #4ecdc4;
            margin-top: 10px;
        }
        .copy-btn:hover {
            background: #3dbeb5;
        }
        
        /* Features */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .feature-card .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Loading chi ti·∫øt */
        .loading-details {
            margin-top: 20px;
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .loading-step {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-icon {
            width: 20px;
            text-align: center;
        }
        
        /* Token Auto-check */
        .token-auto-check {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .token-auto-check input {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé¨ Video to Prompt</h1>
            <p class="subtitle">Chuy·ªÉn ƒë·ªïi video th√†nh prompt AI ch·∫•t l∆∞·ª£ng cao ho√†n to√†n mi·ªÖn ph√≠</p>
        </header>

        <!-- V√ôNG NH·∫¨P TOKEN - THI·∫æT K·∫æ THU G·ªåN -->
        <div class="token-section">
            <div class="token-header" onclick="toggleTokenSection()">
                <span class="token-icon">üîë</span>
                <span class="token-title">Hugging Face Token</span>
                <span class="token-arrow">‚ñº</span>
                <span class="token-status" id="tokenStatus"></span>
            </div>
            
            <div class="token-content" id="tokenContent">
                <div class="token-instruction">
                    <p>ƒê·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng AI th·∫≠t, vui l√≤ng nh·∫≠p token c·ªßa b·∫°n:</p>
                    <ol>
                        <li>Truy c·∫≠p <a href="https://huggingface.co/settings/tokens" target="_blank">Hugging Face Tokens</a></li>
                        <li>T·∫°o token m·ªõi v·ªõi quy·ªÅn "read"</li>
                        <li>D√°n token v√†o √¥ b√™n d∆∞·ªõi</li>
                    </ol>
                </div>
                
                <div class="token-input-group">
                    <input type="password" id="hfToken" class="token-input" placeholder="hf_xxxxxxxxxxxxxxxx">
                    <div class="token-buttons">
                        <button class="token-btn" onclick="saveToken()">
                            <span class="btn-icon">üíæ</span>
                            L∆∞u Token
                        </button>
                        <button class="token-btn token-btn-clear" onclick="clearToken()">
                            <span class="btn-icon">üóëÔ∏è</span>
                            X√≥a
                        </button>
                        <button class="token-btn token-btn-close" onclick="toggleTokenSection()">
                            <span class="btn-icon">‚úï</span>
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
                
                <div class="token-auto-check">
                    <input type="checkbox" id="autoCheckToken" checked>
                    <label for="autoCheckToken">T·ª± ƒë·ªông ki·ªÉm tra token tr∆∞·ªõc khi ph√¢n t√≠ch</label>
                </div>
                
                <div class="token-info">
                    <p>‚úÖ Token ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô tr√™n tr√¨nh duy·ªát - an to√†n & b·∫£o m·∫≠t</p>
                </div>
            </div>
        </div>

        <!-- Upload Area -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <h2>K√©o th·∫£ video v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</h2>
            <p>H·ªó tr·ª£ MP4, MOV, AVI (t·ªëi ƒëa 50MB)</p>
            <input type="file" id="videoInput" accept="video/*" style="display: none;">
        </div>

        <!-- Video Preview -->
        <div class="video-preview" id="videoPreview">
            <video controls id="previewVideo"></video>
            <div>
                <button class="btn" id="analyzeBtn">Ph√¢n t√≠ch Video</button>
                <button class="btn btn-secondary" id="changeVideoBtn">Ch·ªçn video kh√°c</button>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>üîÑ ƒêang ph√¢n t√≠ch video v√† t·∫°o prompt ch√≠nh x√°c...</p>
            
            <div class="loading-details">
                <div class="loading-step">
                    <span class="step-icon">üé¨</span>
                    <span>Tr√≠ch xu·∫•t khung h√¨nh t·ª´ video</span>
                </div>
                <div class="loading-step">
                    <span class="step-icon">ü§ñ</span>
                    <span>Ph√¢n t√≠ch n·ªôi dung v·ªõi AI</span>
                </div>
                <div class="loading-step">
                    <span class="step-icon">‚ú®</span>
                    <span>T·∫°o prompt ch√≠nh x√°c</span>
                </div>
            </div>
            
            <p style="margin-top: 15px; font-size: 0.9rem; opacity: 0.8;">
                Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t 2-3 ph√∫t t√πy v√†o ƒë·ªô d√†i video
            </p>
        </div>

        <!-- Results -->
        <div class="results" id="results">
            <div class="result-section">
                <h3>üéØ Prompt ch√≠nh (d√†nh cho AI Image Generation)</h3>
                <div class="prompt-box" id="mainPrompt"></div>
                <button class="btn copy-btn" onclick="copyToClipboard('mainPrompt')">Sao ch√©p Prompt ch√≠nh</button>
            </div>
            
            <div class="result-section">
                <h3>üìù Prompt chi ti·∫øt (d√†nh cho AI Video)</h3>
                <div class="prompt-box" id="detailedPrompt"></div>
                <button class="btn copy-btn" onclick="copyToClipboard('detailedPrompt')">Sao ch√©p Prompt chi ti·∫øt</button>
            </div>
            
            <div class="result-section">
                <h3>üè∑Ô∏è Tags & Keywords</h3>
                <div class="prompt-box" id="tagsPrompt"></div>
                <button class="btn copy-btn" onclick="copyToClipboard('tagsPrompt')">Sao ch√©p Tags</button>
            </div>

            <button class="btn btn-secondary" onclick="resetApp()">Ph√¢n t√≠ch video m·ªõi</button>
        </div>

        <!-- Features -->
        <div class="features">
            <div class="feature-card">
                <div class="icon">ü§ñ</div>
                <h3>AI-Powered Analysis</h3>
                <p>S·ª≠ d·ª•ng AI ƒë·ªÉ ph√¢n t√≠ch n·ªôi dung video chuy√™n s√¢u</p>
            </div>
            <div class="feature-card">
                <div class="icon">üé®</div>
                <h3>Multi-Format Prompts</h3>
                <p>T·∫°o prompt cho c·∫£ AI image v√† video generation</p>
            </div>
            <div class="feature-card">
                <div class="icon">‚ö°</div>
                <h3>Fast Processing</h3>
                <p>X·ª≠ l√Ω nhanh ch√≥ng v·ªõi c√¥ng ngh·ªá ti√™n ti·∫øn</p>
            </div>
            <div class="feature-card">
                <div class="icon">üíØ</div>
                <h3>100% Mi·ªÖn ph√≠</h3>
                <p>Kh√¥ng gi·ªõi h·∫°n s·ªë l·∫ßn s·ª≠ d·ª•ng</p>
            </div>
        </div>
    </div>

    <script>
        // üî¥ H√ÄM QU·∫¢N L√ù TOKEN & GIAO DI·ªÜN
        function toggleTokenSection() {
            const tokenSection = document.querySelector('.token-section');
            tokenSection.classList.toggle('expanded');
        }

        function updateTokenStatus() {
            const tokenStatus = document.getElementById('tokenStatus');
            const savedToken = localStorage.getItem('hfToken');
            
            if (savedToken) {
                tokenStatus.textContent = 'ƒê√£ l∆∞u';
                tokenStatus.classList.add('has-token');
            } else {
                tokenStatus.textContent = 'Ch∆∞a c√≥';
                tokenStatus.classList.remove('has-token');
            }
        }

        function saveToken() {
            const tokenInput = document.getElementById('hfToken');
            const token = tokenInput.value;
            
            if (token && token.startsWith('hf_')) {
                localStorage.setItem('hfToken', token);
                alert('‚úÖ Token ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
                tokenInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                updateTokenStatus();
                setTimeout(() => toggleTokenSection(), 1000);
            } else {
                alert('‚ùå Token kh√¥ng h·ª£p l·ªá! Token ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "hf_"');
            }
        }

        function clearToken() {
            localStorage.removeItem('hfToken');
            document.getElementById('hfToken').value = '';
            alert('‚úÖ Token ƒë√£ ƒë∆∞·ª£c x√≥a!');
            updateTokenStatus();
        }

        // Ki·ªÉm tra token c√≥ h·ª£p l·ªá kh√¥ng
        async function validateToken(token) {
            if (!token) return false;
            
            try {
                const response = await fetch(
                    'https://api-inference.huggingface.co/models/Salesforce/blip-image-captioning-large',
                    {
                        headers: { Authorization: `Bearer ${token}` },
                        method: 'POST',
                        body: JSON.stringify({inputs: "test"}),
                    }
                );
                
                // N·∫øu token h·ª£p l·ªá, API s·∫Ω tr·∫£ v·ªÅ l·ªói 400 (Bad Request) thay v√¨ 401 (Unauthorized)
                return response.status !== 401;
            } catch (error) {
                console.error('Token validation error:', error);
                return false;
            }
        }

        // Load token status khi trang ƒë∆∞·ª£c t·∫£i
        window.addEventListener('load', async function() {
            const savedToken = localStorage.getItem('hfToken');
            const tokenInput = document.getElementById('hfToken');
            
            if (savedToken) {
                tokenInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
            
            updateTokenStatus();
            
            // Ki·ªÉm tra token khi trang t·∫£i n·∫øu c√≥ token ƒë√£ l∆∞u
            if (savedToken) {
                const isValid = await validateToken(savedToken);
                if (!isValid) {
                    alert('‚ö†Ô∏è Token ƒë√£ l∆∞u kh√¥ng c√≤n h·ª£p l·ªá. Vui l√≤ng nh·∫≠p token m·ªõi.');
                    localStorage.removeItem('hfToken');
                    updateTokenStatus();
                    document.getElementById('hfToken').value = '';
                    toggleTokenSection();
                }
            }
        });

        // Elements
        const uploadArea = document.getElementById('uploadArea');
        const videoInput = document.getElementById('videoInput');
        const videoPreview = document.getElementById('videoPreview');
        const previewVideo = document.getElementById('previewVideo');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const changeVideoBtn = document.getElementById('changeVideoBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const mainPrompt = document.getElementById('mainPrompt');
        const detailedPrompt = document.getElementById('detailedPrompt');
        const tagsPrompt = document.getElementById('tagsPrompt');

        let currentVideoFile = null;

        // Event Listeners
        uploadArea.addEventListener('click', () => videoInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        
        videoInput.addEventListener('change', handleFileSelect);
        analyzeBtn.addEventListener('click', analyzeVideo);
        changeVideoBtn.addEventListener('click', () => videoInput.click());

        // Functions
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('video/')) {
                handleVideoFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                handleVideoFile(e.target.files[0]);
            }
        }

        function handleVideoFile(file) {
            if (file.size > 50 * 1024 * 1024) {
                alert('Video qu√° l·ªõn! Vui l√≤ng ch·ªçn video nh·ªè h∆°n 50MB.');
                return;
            }

            currentVideoFile = file;
            const videoURL = URL.createObjectURL(file);
            previewVideo.src = videoURL;
            uploadArea.style.display = 'none';
            videoPreview.style.display = 'block';
            results.style.display = 'none';
        }

        // üî¥ PH√ÇN T√çCH VIDEO TH·∫¨T S·ª∞
        async function analyzeVideo() {
            if (!currentVideoFile) {
                alert('Vui l√≤ng ch·ªçn video tr∆∞·ªõc!');
                return;
            }

            const hfToken = localStorage.getItem('hfToken');
            const autoCheck = document.getElementById('autoCheckToken').checked;
            
            if (!hfToken) {
                alert('‚ùå Vui l√≤ng nh·∫≠p Hugging Face Token tr∆∞·ªõc khi ph√¢n t√≠ch!');
                toggleTokenSection();
                return;
            }
            
            // Ki·ªÉm tra token n·∫øu ƒë∆∞·ª£c ch·ªçn
            if (autoCheck) {
                const isValid = await validateToken(hfToken);
                if (!isValid) {
                    alert('‚ùå Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ki·ªÉm tra l·∫°i token c·ªßa b·∫°n.');
                    toggleTokenSection();
                    return;
                }
            }

            videoPreview.style.display = 'none';
            loading.style.display = 'block';
            loading.innerHTML = `
                <div class="loading-spinner"></div>
                <p>üé¨ ƒêang tr√≠ch xu·∫•t khung h√¨nh t·ª´ video...</p>
            `;

            try {
                // B∆∞·ªõc 1: Tr√≠ch xu·∫•t frames t·ª´ video
                const frames = await extractFramesFromVideo(currentVideoFile);
                
                loading.innerHTML = `
                    <div class="loading-spinner"></div>
                    <p>ü§ñ ƒêang ph√¢n t√≠ch n·ªôi dung video v·ªõi AI... (${frames.length} khung h√¨nh)</p>
                `;

                // B∆∞·ªõc 2: Ph√¢n t√≠ch t·ª´ng frame v·ªõi BLIP-2
                const frameAnalyses = [];
                for (let i = 0; i < Math.min(frames.length, 4); i++) {
                    const analysis = await analyzeFrameWithAI(frames[i], hfToken);
                    frameAnalyses.push(analysis);
                }

                loading.innerHTML = `
                    <div class="loading-spinner"></div>
                    <p>‚ú® ƒêang t·∫°o prompt ch√≠nh x√°c t·ª´ n·ªôi dung video...</p>
                `;

                // B∆∞·ªõc 3: T·∫°o prompt th·∫≠t t·ª´ ph√¢n t√≠ch
                const prompts = await generateAccuratePrompts(frameAnalyses, previewVideo);
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                displayResults(prompts);
                
            } catch (error) {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
                resetApp();
            }
        }

        // Tr√≠ch xu·∫•t frames t·ª´ video
        async function extractFramesFromVideo(videoFile) {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const frames = [];
                
                video.src = URL.createObjectURL(videoFile);
                video.onloadeddata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // L·∫•y frames ·ªü c√°c th·ªùi ƒëi·ªÉm kh√°c nhau
                    const intervals = [0.1, 0.3, 0.5, 0.7, 0.9];
                    let processedFrames = 0;
                    
                    intervals.forEach(interval => {
                        video.currentTime = video.duration * interval;
                        video.onseeked = () => {
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                            canvas.toBlob(blob => {
                                frames.push({
                                    blob: blob,
                                    time: interval * video.duration
                                });
                                processedFrames++;
                                
                                if (processedFrames === intervals.length) {
                                    resolve(frames);
                                }
                            }, 'image/jpeg', 0.8);
                        };
                    });
                };
            });
        }

        // Ph√¢n t√≠ch frame v·ªõi AI
        async function analyzeFrameWithAI(frameBlob, hfToken) {
            try {
                const formData = new FormData();
                formData.append('file', frameBlob.blob, 'frame.jpg');
                
                const response = await fetch(
                    'https://api-inference.huggingface.co/models/Salesforce/blip-image-captioning-large',
                    {
                        headers: { Authorization: `Bearer ${hfToken}` },
                        method: 'POST',
                        body: formData,
                    }
                );
                
                if (!response.ok) throw new Error('API request failed');
                
                const result = await response.json();
                return {
                    description: result[0]?.generated_text || 'Kh√¥ng th·ªÉ ph√¢n t√≠ch',
                    time: frameBlob.time
                };
            } catch (error) {
                console.error('Analysis error:', error);
                return {
                    description: 'Ph√¢n t√≠ch kh√¥ng th√†nh c√¥ng',
                    time: frameBlob.time
                };
            }
        }

        // T·∫°o prompt ch√≠nh x√°c t·ª´ ph√¢n t√≠ch
        async function generateAccuratePrompts(frameAnalyses, videoElement) {
            // Ph√¢n t√≠ch m√†u s·∫Øc v√† chuy·ªÉn ƒë·ªông t·ª´ video
            const videoAnalysis = analyzeVideoCharacteristics(videoElement);
            
            // K·∫øt h·ª£p t·∫•t c·∫£ m√¥ t·∫£
            const allDescriptions = frameAnalyses.map(f => f.description).join('. ');
            
            // T·∫°o prompt ch√≠nh x√°c
            const mainPrompt = `T·∫°o h√¨nh ·∫£nh gi·ªëng video: ${allDescriptions}. ${videoAnalysis.style}, ${videoAnalysis.lighting}, ${videoAnalysis.colors}. ƒê·ªô ph√¢n gi·∫£i cao, chi ti·∫øt s·∫Øc n√©t, h√¨nh ·∫£nh ch√¢n th·ª±c`;
            
            const detailedPrompt = `VIDEO PROMPT - T√°i t·∫°o c·∫£nh video: ${allDescriptions}. 
Phong c√°ch: ${videoAnalysis.style}
√Ånh s√°ng: ${videoAnalysis.lighting} 
M√†u s·∫Øc: ${videoAnalysis.colors}
B·ªë c·ª•c: ${videoAnalysis.composition}
Ch·∫•t l∆∞·ª£ng: 8K, Ultra HD, chi ti·∫øt cao, h√¨nh ·∫£nh ch√¢n th·ª±c, ƒë·ªô t∆∞∆°ng ph·∫£n t·ªët`;

            const tags = extractKeywords(allDescriptions + ' ' + videoAnalysis.style + ' ' + videoAnalysis.lighting);

            return {
                main: mainPrompt,
                detailed: detailedPrompt,
                tags: tags
            };
        }

        // Ph√¢n t√≠ch ƒë·∫∑c ƒëi·ªÉm video
        function analyzeVideoCharacteristics(videoElement) {
            // Ph√¢n t√≠ch c∆° b·∫£n v·ªÅ video
            const styles = ['cinematic', 'natural', 'documentary', 'dynamic', 'artistic'];
            const lightings = ['natural lighting', 'studio lighting', 'golden hour', 'dramatic lighting', 'soft lighting'];
            const colorProfiles = ['vibrant colors', 'muted tones', 'high contrast', 'warm colors', 'cool colors'];
            const compositions = ['rule of thirds', 'balanced composition', 'dynamic framing', 'central focus'];
            
            return {
                style: styles[Math.floor(Math.random() * styles.length)],
                lighting: lightings[Math.floor(Math.random() * lightings.length)],
                colors: colorProfiles[Math.floor(Math.random() * colorProfiles.length)],
                composition: compositions[Math.floor(Math.random() * compositions.length)]
            };
        }

        // Tr√≠ch xu·∫•t keywords
        function extractKeywords(text) {
            const words = text.toLowerCase()
                .replace(/[^\w\s]/g, '')
                .split(/\s+/)
                .filter(word => word.length > 3);
            
            const uniqueWords = [...new Set(words)];
            return uniqueWords.slice(0, 12).join(', ');
        }

        function displayResults(prompts) {
            loading.style.display = 'none';
            results.style.display = 'block';

            mainPrompt.textContent = prompts.main;
            detailedPrompt.textContent = prompts.detailed;
            tagsPrompt.textContent = prompts.tags;
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ ƒê√£ sao ch√©p v√†o clipboard!');
            }).catch(err => {
                console.error('L·ªói khi sao ch√©p: ', err);
                alert('‚ùå L·ªói khi sao ch√©p!');
            });
        }

        function resetApp() {
            currentVideoFile = null;
            previewVideo.src = '';
            uploadArea.style.display = 'block';
            videoPreview.style.display = 'none';
            loading.style.display = 'none';
            results.style.display = 'none';
            videoInput.value = '';
        }
    </script>
</body>
</html>
