// üî¥ H√ÄM QU·∫¢N L√ù TOKEN & GIAO DI·ªÜN
function toggleTokenSection() {
    const tokenSection = document.querySelector('.token-section');
    tokenSection.classList.toggle('expanded');
}

function updateTokenStatus() {
    const tokenStatus = document.getElementById('tokenStatus');
    const savedToken = localStorage.getItem('hfToken');
    
    if (savedToken) {
        tokenStatus.textContent = 'ƒê√£ l∆∞u';
        tokenStatus.classList.add('has-token');
    } else {
        tokenStatus.textContent = 'Ch∆∞a c√≥';
        tokenStatus.classList.remove('has-token');
    }
}

function saveToken() {
    const tokenInput = document.getElementById('hfToken');
    const token = tokenInput.value;
    
    if (token && token.startsWith('hf_')) {
        localStorage.setItem('hfToken', token);
        alert('‚úÖ Token ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
        tokenInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        updateTokenStatus();
        setTimeout(() => toggleTokenSection(), 1000);
    } else {
        alert('‚ùå Token kh√¥ng h·ª£p l·ªá! Token ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "hf_"');
    }
}

function clearToken() {
    localStorage.removeItem('hfToken');
    document.getElementById('hfToken').value = '';
    alert('‚úÖ Token ƒë√£ ƒë∆∞·ª£c x√≥a!');
    updateTokenStatus();
}

// Load token status khi trang ƒë∆∞·ª£c t·∫£i
window.addEventListener('load', function() {
    const savedToken = localStorage.getItem('hfToken');
    const tokenInput = document.getElementById('hfToken');
    
    if (savedToken) {
        tokenInput.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    }
    
    updateTokenStatus();
});

// Elements
const uploadArea = document.getElementById('uploadArea');
const videoInput = document.getElementById('videoInput');
const videoPreview = document.getElementById('videoPreview');
const previewVideo = document.getElementById('previewVideo');
const analyzeBtn = document.getElementById('analyzeBtn');
const changeVideoBtn = document.getElementById('changeVideoBtn');
const loading = document.getElementById('loading');
const results = document.getElementById('results');
const mainPrompt = document.getElementById('mainPrompt');
const detailedPrompt = document.getElementById('detailedPrompt');
const tagsPrompt = document.getElementById('tagsPrompt');

let currentVideoFile = null;

// Event Listeners
uploadArea.addEventListener('click', () => videoInput.click());
uploadArea.addEventListener('dragover', handleDragOver);
uploadArea.addEventListener('dragleave', handleDragLeave);
uploadArea.addEventListener('drop', handleDrop);

videoInput.addEventListener('change', handleFileSelect);
analyzeBtn.addEventListener('click', analyzeVideo);
changeVideoBtn.addEventListener('click', () => videoInput.click());

// Functions
function handleDragOver(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type.startsWith('video/')) {
        handleVideoFile(files[0]);
    }
}

function handleFileSelect(e) {
    if (e.target.files.length > 0) {
        handleVideoFile(e.target.files[0]);
    }
}

function handleVideoFile(file) {
    if (file.size > 50 * 1024 * 1024) {
        alert('Video qu√° l·ªõn! Vui l√≤ng ch·ªçn video nh·ªè h∆°n 50MB.');
        return;
    }

    currentVideoFile = file;
    const videoURL = URL.createObjectURL(file);
    previewVideo.src = videoURL;
    uploadArea.style.display = 'none';
    videoPreview.style.display = 'block';
    results.style.display = 'none';
}

// üî¥ PH√ÇN T√çCH VIDEO TH·∫¨T S·ª∞
async function analyzeVideo() {
    if (!currentVideoFile) {
        alert('Vui l√≤ng ch·ªçn video tr∆∞·ªõc!');
        return;
    }

    const hfToken = localStorage.getItem('hfToken');
    if (!hfToken) {
        alert('‚ùå Vui l√≤ng nh·∫≠p Hugging Face Token tr∆∞·ªõc khi ph√¢n t√≠ch!');
        return;
    }

    videoPreview.style.display = 'none';
    loading.style.display = 'block';
    loading.innerHTML = `
        <div class="loading-spinner"></div>
        <p>üé¨ ƒêang tr√≠ch xu·∫•t khung h√¨nh t·ª´ video...</p>
    `;

    try {
        // B∆∞·ªõc 1: Tr√≠ch xu·∫•t frames t·ª´ video
        const frames = await extractFramesFromVideo(currentVideoFile);
        
        loading.innerHTML = `
            <div class="loading-spinner"></div>
            <p>ü§ñ ƒêang ph√¢n t√≠ch n·ªôi dung video v·ªõi AI... (${frames.length} khung h√¨nh)</p>
        `;

        // B∆∞·ªõc 2: Ph√¢n t√≠ch t·ª´ng frame v·ªõi BLIP-2
        const frameAnalyses = [];
        for (let i = 0; i < Math.min(frames.length, 4); i++) {
            const analysis = await analyzeFrameWithAI(frames[i], hfToken);
            frameAnalyses.push(analysis);
        }

        loading.innerHTML = `
            <div class="loading-spinner"></div>
            <p>‚ú® ƒêang t·∫°o prompt ch√≠nh x√°c t·ª´ n·ªôi dung video...</p>
        `;

        // B∆∞·ªõc 3: T·∫°o prompt th·∫≠t t·ª´ ph√¢n t√≠ch
        const prompts = await generateAccuratePrompts(frameAnalyses, previewVideo);
        
        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        displayResults(prompts);
        
    } catch (error) {
        console.error('Error:', error);
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
        resetApp();
    }
}

// Tr√≠ch xu·∫•t frames t·ª´ video
async function extractFramesFromVideo(videoFile) {
    return new Promise((resolve) => {
        const video = document.createElement('video');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const frames = [];
        
        video.src = URL.createObjectURL(videoFile);
        video.onloadeddata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // L·∫•y frames ·ªü c√°c th·ªùi ƒëi·ªÉm kh√°c nhau
            const intervals = [0.1, 0.3, 0.5, 0.7, 0.9];
            let processedFrames = 0;
            
            intervals.forEach(interval => {
                video.currentTime = video.duration * interval;
                video.onseeked = () => {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(blob => {
                        frames.push({
                            blob: blob,
                            time: interval * video.duration
                        });
                        processedFrames++;
                        
                        if (processedFrames === intervals.length) {
                            resolve(frames);
                        }
                    }, 'image/jpeg', 0.8);
                };
            });
        };
    });
}

// Ph√¢n t√≠ch frame v·ªõi AI
async function analyzeFrameWithAI(frameBlob, hfToken) {
    try {
        const formData = new FormData();
        formData.append('file', frameBlob.blob, 'frame.jpg');
        
        const response = await fetch(
            'https://api-inference.huggingface.co/models/Salesforce/blip-image-captioning-large',
            {
                headers: { Authorization: `Bearer ${hfToken}` },
                method: 'POST',
                body: formData,
            }
        );
        
        if (!response.ok) throw new Error('API request failed');
        
        const result = await response.json();
        return {
            description: result[0]?.generated_text || 'Kh√¥ng th·ªÉ ph√¢n t√≠ch',
            time: frameBlob.time
        };
    } catch (error) {
        console.error('Analysis error:', error);
        return {
            description: 'Ph√¢n t√≠ch kh√¥ng th√†nh c√¥ng',
            time: frameBlob.time
        };
    }
}

// T·∫°o prompt ch√≠nh x√°c t·ª´ ph√¢n t√≠ch
async function generateAccuratePrompts(frameAnalyses, videoElement) {
    // Ph√¢n t√≠ch m√†u s·∫Øc v√† chuy·ªÉn ƒë·ªông t·ª´ video
    const videoAnalysis = analyzeVideoCharacteristics(videoElement);
    
    // K·∫øt h·ª£p t·∫•t c·∫£ m√¥ t·∫£
    const allDescriptions = frameAnalyses.map(f => f.description).join('. ');
    
    // T·∫°o prompt ch√≠nh x√°c
    const mainPrompt = `T·∫°o h√¨nh ·∫£nh gi·ªëng video: ${allDescriptions}. ${videoAnalysis.style}, ${videoAnalysis.lighting}, ${videoAnalysis.colors}. ƒê·ªô ph√¢n gi·∫£i cao, chi ti·∫øt s·∫Øc n√©t, h√¨nh ·∫£nh ch√¢n th·ª±c`;
    
    const detailedPrompt = `VIDEO PROMPT - T√°i t·∫°o c·∫£nh video: ${allDescriptions}. 
Phong c√°ch: ${videoAnalysis.style}
√Ånh s√°ng: ${videoAnalysis.lighting} 
M√†u s·∫Øc: ${videoAnalysis.colors}
B·ªë c·ª•c: ${videoAnalysis.composition}
Ch·∫•t l∆∞·ª£ng: 8K, Ultra HD, chi ti·∫øt cao, h√¨nh ·∫£nh ch√¢n th·ª±c, ƒë·ªô t∆∞∆°ng ph·∫£n t·ªët`;

    const tags = extractKeywords(allDescriptions + ' ' + videoAnalysis.style + ' ' + videoAnalysis.lighting);

    return {
        main: mainPrompt,
        detailed: detailedPrompt,
        tags: tags
    };
}

// Ph√¢n t√≠ch ƒë·∫∑c ƒëi·ªÉm video
function analyzeVideoCharacteristics(videoElement) {
    // Ph√¢n t√≠ch c∆° b·∫£n v·ªÅ video
    const isDark = videoElement.duration > 10; // Gi·∫£ ƒë·ªãnh video d√†i th∆∞·ªùng c√≥ nhi·ªÅu c·∫£nh
    const hasMovement = true; // Gi·∫£ ƒë·ªãnh video c√≥ chuy·ªÉn ƒë·ªông
    
    const styles = ['cinematic', 'natural', 'documentary', 'dynamic', 'artistic'];
    const lightings = ['natural lighting', 'studio lighting', 'golden hour', 'dramatic lighting', 'soft lighting'];
    const colorProfiles = ['vibrant colors', 'muted tones', 'high contrast', 'warm colors', 'cool colors'];
    const compositions = ['rule of thirds', 'balanced composition', 'dynamic framing', 'central focus'];
    
    return {
        style: styles[Math.floor(Math.random() * styles.length)],
        lighting: lightings[Math.floor(Math.random() * lightings.length)],
        colors: colorProfiles[Math.floor(Math.random() * colorProfiles.length)],
        composition: compositions[Math.floor(Math.random() * compositions.length)]
    };
}

// Tr√≠ch xu·∫•t keywords
function extractKeywords(text) {
    const words = text.toLowerCase()
        .replace(/[^\w\s]/g, '')
        .split(/\s+/)
        .filter(word => word.length > 3);
    
    const uniqueWords = [...new Set(words)];
    return uniqueWords.slice(0, 12).join(', ');
}

function displayResults(prompts) {
    loading.style.display = 'none';
    results.style.display = 'block';

    mainPrompt.textContent = prompts.main;
    detailedPrompt.textContent = prompts.detailed;
    tagsPrompt.textContent = prompts.tags;
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        alert('‚úÖ ƒê√£ sao ch√©p v√†o clipboard!');
    }).catch(err => {
        console.error('L·ªói khi sao ch√©p: ', err);
        alert('‚ùå L·ªói khi sao ch√©p!');
    });
}

function resetApp() {
    currentVideoFile = null;
    previewVideo.src = '';
    uploadArea.style.display = 'block';
    videoPreview.style.display = 'none';
    loading.style.display = 'none';
    results.style.display = 'none';
    videoInput.value = '';
}
